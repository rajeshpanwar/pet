/**
 * Created by rajesh on 17/10/16.
 */


exports.registration = function (req, res, next) {
    if (!req.body.email) {
        return res.send(406, {email: "Required Field"});
    }

    // req.body.password encrypt password

    if (!req.body.password) {
        return res.send(406, {password: "Required Field"});
    }


    require('db').connect('userdb', function (err, db) {
        if (err) {
            return res.send(500, 'Error in data base connection')
        }

        db.collection('users').findOne({email: req.body.email}, function (err, user) {
            if (err) {
                return res.send(406, "Something Went Wrong");
            }
            if (!user) {
                db.collection('users').save(req.body, function (err, data) {
                    if (err) {
                        return res.send(406, "Something Went Wrong");
                    }
                    req.session.user = data;
                    res.send(200, data);
                })
            } else {
                return res.send(409, "Duplicate User");
            }
        })
    })
}


exports.login = function (req, res, next) {

    if (!req.body.email) {
        return res.send(406, {email: "Required Field"});
    }

    // req.body.password encrypt password

    if (!req.body.password) {
        return res.send(406, {password: "Required Field"});
    }


    require('db').connect('userdb', function (err, db) {
        if (err) {
            return res.send(500, 'Error in data base connection')
        }
        db.collection('users').findOne({email: req.body.email}, function (err, user) {
            if (err) {
                return res.send(406, "Something Went Wrong");
            }
            if (!user) {
                return res.send(406, "Invalid user email or password");
            }

            if (user.password != req.body.password) {
                return res.send(406, "Invalid user email or password");
            } else {
                req.session.user = user;
                res.send(200, user);
            }
        })
    })

}

exports.petlist = function (req, res, next) {
    require('db').connect('Pets', function (err, db) {
        if (err) {
            return res.send(500, 'Error in data base connection')
        }
        db.collection('pets').find({}).toArray(function (err, records) {
            if (err) {
                return res.send(406, "Something Went Wrong");
            }
            res.send(records);
        })
    })
}

exports.selectPetlist = function (req, res, next) {
    if (!req.session.user) {
        return res.send(200, []);
    }
    require('db').connect('userdb', function (err, db) {
        if (err) {
            return res.send(500, 'Error in data base connection')
        }
        db.collection('selectedPets').findOne({user_id: String(req.session.user._id)}, function (err, selectedPets) {
            if (err) {
                return res.send(406, "Something Went Wrong");
            }
            if (selectedPets && selectedPets.pets) {
                res.send(selectedPets.pets);
            } else {
                res.send(200, []);
            }
        })
    })

}

exports.updatepetSelection = function (req, res, next) {

    console.log("pets >>>>>>>>>", req.body.pets);

    if (!req.session.user) {
        return res.send(406, "Login First")
    }

    require('db').connect('userdb', function (err, db) {
        if (err) {
            return res.send(500, 'Error in data base connection')
        }
        db.collection('selectedPets').update({user_id: String(req.session.user._id)}, {$set: {pets: req.body.pets}}, {upsert: true}, function (err, update) {

            console.log("update >>>>>>>>>>>", err, update)

            if (err) {
                return res.send(406, "Something Went Wrong");
            } else {
                return res.send(200, "update Successfully");
            }
        })
    })

}
