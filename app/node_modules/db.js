/**
 * Created by rajesh on 17/10/16.
 */


var MongoClient = require('mongodb').MongoClient;

var databases = {};


exports.connect = function (dbname, cb) {

    console.log("connect called", dbname);

    if (databases[dbname]) {
        return cb(null, databases[dbname]);
    }

    var host = 'localhost'  // should be taken for config
    var port = '27017'  // should be taken for config

    var url = 'mongodb://' + host + ":" + port + '/' + dbname;

    var options = {};

    MongoClient.connect(url, options, function (err, db) {
        if (err) {
            cb(err, null);
        }

        else {
            db.dbName = dbname;
            db.on('close', function (error, info) {
                var dbname = "UNKNOWN";
                if (info && info.db.databaseName) {
                    dbname = info.db.databaseName;
                    delete databases[info.db.databaseName];
                }
                if (info && info.dbName) {
                    dbname = info.dbName;
                    delete databases[dbname];
                }
            });

            cb(err, db);
        }
    })
}
